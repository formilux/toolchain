2008/05/30 (WT):
 - backported from 2.3.2 to 2.2.5, comments left intact.
 - original found in crosstool-0.43
 - merged glibc-linuxthreads patch from http://www.andric.com/cross/patches/

Fixes errors like

# gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crtn.o(.text+0x0):mipsel-unknown-linux-gnu/gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crtn.S:20: multiple definition of `dummy'
# gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crti.o(.text+0x0):mipsel-unknown-linux-gnu/gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crti.S:42: first defined here
# /gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crti.o(.init+0x28):mipsel-unknown-linux-gnu/gcc-3.4.0-glibc-2.3.2/build-glibc/csu/crti.S:58: undefined reference to `i_am_not_a_leaf'

CVSROOT:	/cvs/glibc
Module name:	libc
Changes by:	aj@sourceware.org	2003-12-02 07:37:29

Modified files:
	.              : configure.in configure config.make.in 
	csu            : Makefile 
	locale         : Makefile 
	linuxthreads   : Makefile 
	linuxthreads/sysdeps/unix/sysv/linux/x86_64: Makefile 
	nptl           : Makefile 
	nptl/sysdeps/unix/sysv/linux/x86_64: Makefile 

Log message:
	* config.make.in (fno-unit-at-a-time): Define.
	
	* configure.in: Add test for -fno-unit-at-a-time.
	Fix text for -fpie.
	
	* csu/Makefile (CFLAGS-initfini.s): Add $(fno_unit_at_a_time).
	* locale/Makefile (CFLAGS-loadlocale.c): Likewise.
	
	For linuxthreads:
	* Makefile (CFLAGS-pt-initfini.s): Add $(fno_unit_at_a_time).
	* sysdeps/unix/sysv/linux/x86_64/Makefile (CFLAGS-pt-initfini.s):
	Likewise.
	
	For nptl:
	* Makefile (CFLAGS-pt-initfini.s): Add $(fno_unit_at_a_time).
	* sysdeps/unix/sysv/linux/x86_64/Makefile (CFLAGS-pt-initfini.s):
	Likewise.

Main glibc change retrieved with
wget -O foo.patch 'http://sources.redhat.com/cgi-bin/cvsweb.cgi/libc/config.make.in.diff?r1=1.98&r2=1.99&cvsroot=glibc' \
'http://sources.redhat.com/cgi-bin/cvsweb.cgi/libc/configure.diff?r1=1.393&r2=1.394&cvsroot=glibc' \
'http://sources.redhat.com/cgi-bin/cvsweb.cgi/libc/csu/Makefile.diff?r1=1.71&r2=1.72&cvsroot=glibc' \
'http://sources.redhat.com/cgi-bin/cvsweb.cgi/libc/locale/Makefile.diff?r1=1.71&r2=1.72&cvsroot=glibc'

and then rediffed against glibc-2.3.2
See also ../glibc-linuxthreads-2.3.2/glibc-linuxthreads-2.3.2-allow-3.4.patch

diff -urN glibc-2.2.5/config.make.in glibc-2.2.5.fixed/config.make.in
--- glibc-2.2.5/config.make.in	Sat May 31 00:18:55 2008
+++ glibc-2.2.5.fixed/config.make.in	Sat May 31 00:18:36 2008
@@ -47,6 +47,7 @@
 with-cvs = @with_cvs@
 old-glibc-headers = @old_glibc_headers@
 unwind-find-fde = @libc_cv_gcc_unwind_find_fde@
+fno-unit-at-a-time = @fno_unit_at_a_time@
 
 static-libgcc = @libc_cv_gcc_static_libgcc@
 
diff -urN glibc-2.2.5/configure glibc-2.2.5.fixed/configure
--- glibc-2.2.5/configure	Fri May 30 23:33:33 2008
+++ glibc-2.2.5.fixed/configure	Sat May 31 00:14:19 2008
@@ -2939,6 +2939,35 @@
 fi
 
 
+echo "$as_me:$LINENO: checking for -fno-unit-at-a-time" >&5
+echo $ECHO_N "checking for -fno-unit-at-a-time... $ECHO_C" >&6
+if test "${libc_cv_fno_unit_at_a_time+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  cat > conftest.c <<EOF
+int foo;
+EOF
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -S -fno-unit-at-a-time
+			    conftest.c 1>&5'
+  { (eval echo "$as_me:$LINENO: \"$ac_try\"") >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); }; }
+then
+  libc_cv_fno_unit_at_a_time=yes
+else
+  libc_cv_fno_unit_at_a_time=no
+fi
+rm -f conftest*
+fi
+echo "$as_me:$LINENO: result: $libc_cv_fno_unit_at_a_time" >&5
+echo "${ECHO_T}$libc_cv_fno_unit_at_a_time" >&6
+if test $libc_cv_fno_unit_at_a_time = yes; then
+  fno_unit_at_a_time=-fno-unit-at-a-time
+fi
+
+
 if test $elf != yes; then
   echo $ac_n "checking for .init and .fini sections""... $ac_c" 1>&6
 echo "configure:2916: checking for .init and .fini sections" >&5
@@ -3921,6 +3950,7 @@
 s%@libc_cv_Bgroup@%$libc_cv_Bgroup%g
 s%@libc_cv_z_combreloc@%$libc_cv_z_combreloc%g
 s%@libc_cv_have_initfini@%$libc_cv_have_initfini%g
+s%@fno_unit_at_a_time@%$fno_unit_at_a_time%g
 s%@no_whole_archive@%$no_whole_archive%g
 s%@exceptions@%$exceptions%g
 s%@LIBGD@%$LIBGD%g

diff -urNd glibc-2.2.5-ct28/linuxthreads/Makefile glibc-2.2.5/linuxthreads/Makefile
--- glibc-2.2.5-ct28/linuxthreads/Makefile	2002-01-21 04:21:14.000000000 +0100
+++ glibc-2.2.5/linuxthreads/Makefile	2004-07-09 15:18:30.000000000 +0200
@@ -54,7 +54,7 @@
 extra-objs += crti.o
 omit-deps += crti
 
-CFLAGS-pt-initfini.s = -g0 -fPIC -fno-inline-functions
+CFLAGS-pt-initfini.s = -g0 -fPIC -fno-inline-functions $(fno-unit-at-a-time)
 endif
 
 librt-tests = ex10 ex11

diff -urNd glibc-2.2.5-ct28/csu/Makefile glibc-2.2.5/csu/Makefile
--- glibc-2.2.5-ct28/csu/Makefile	2001-07-06 06:54:45.000000000 +0200
+++ glibc-2.2.5/csu/Makefile	2004-07-15 17:44:22.326139200 +0200
@@ -92,7 +92,7 @@
 $(objpfx)crt%.o: $(objpfx)crt%.S $(objpfx)defs.h
 	$(compile.S) -g0 $(ASFLAGS-.os) -o $@
 
-CFLAGS-initfini.s = -g0 -fPIC -fno-inline-functions
+CFLAGS-initfini.s = -g0 -fPIC -fno-inline-functions $(fno-unit-at-a-time)
 
 vpath initfini.c $(full_config_sysdirs)
 
diff -urNd glibc-2.2.5-ct28/locale/Makefile glibc-2.2.5/locale/Makefile
--- glibc-2.2.5-ct28/locale/Makefile	2001-08-15 00:37:31.000000000 +0200
+++ glibc-2.2.5/locale/Makefile	2004-07-15 17:44:22.326139200 +0200
@@ -97,6 +97,7 @@
 CFLAGS-charmap.c = -Wno-write-strings -Wno-char-subscripts
 CFLAGS-locfile.c = -Wno-write-strings -Wno-char-subscripts
 CFLAGS-charmap-dir.c = -Wno-write-strings
+CFLAGS-loadlocale.c = $(fno-unit-at-a-time)
 
 # Depend on libc.so so a DT_NEEDED is generated in the shared objects.
 # This ensures they will load libc.so for needed symbols if loaded by

